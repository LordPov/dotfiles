#!/usr/bin/env bash
# Refetch Aliases file
#
#                                                       80x25 linebreak here |

#=============================================================================
# General library configuration
#=============================================================================

DIR=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )
source ${DIR}/getoptx.sh

#=============================================================================
# Usage
#=============================================================================

function usage()
{
cat << EOF
usage: $0
Options:
    -h, --help       help
    -v, --verbose    verbose
EOF
}

#=============================================================================
# Parse Arguments
#=============================================================================

VERBOSE=0
URL='http://zugmaster04:8080/aliases'
FILE='deployment_aliases'

while getoptex "h; help; v; verbose; url:" $@; do
    case ${OPTOPT} in
        h | help )
            usage
            exit 0 ;;
        v | verbose )
            VERBOSE=1 ;;
        url )
            URL=${OPTARG} ;;
        * )
            usage
            exit 0 ;;
    esac
done
shift $((OPTIND-1))

testURL=$1
if [ "$testURL" != "" ]; then
    URL=$testURL
    echo "Overriding url to ${URL}"
fi

#=============================================================================
# Fetch aliases 
#=============================================================================

mkdir -p ${HOME}/.imc
chmod 755 ${HOME}/.imc

TEMP="/tmp/$FILE.down"
FINAL="${HOME}/.imc/$FILE"

if [ $VERBOSE == 1 ]; then
    curl --max-time 60 -f "$URL" > "$TEMP"
else
    curl --max-time 60 -f "$URL" > "$TEMP" 2> /dev/null
fi

if [ -s "$TEMP" -a $? -eq 0 ]; then
    mv "$TEMP" "$FINAL"
    if [ $VERBOSE == 1 ]; then
        echo 'Successful.'
    fi
    exit 0
else
    rm -f "$TEMP"
    echo 'Failed. Original aliases untouched' >&2
    exit 1
fi

